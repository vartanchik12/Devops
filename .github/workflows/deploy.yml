name: CD - Deploy Static Site

on:
  release:
    types: [ published ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Show release info
        run: |
          echo "Запуск деплоя статического сайта"
          echo "Релиз: ${{ github.event.release.tag_name }}"
          echo "Название: ${{ github.event.release.name }}"

      - name: Validate site files
        run: |
          echo "Проверка файлов статического сайта:"
          if [ -f "index.html" ]; then
            echo "index.html найден"
            echo "Содержимое index.html:"
            head -10 index.html
          else
            echo "index.html не найден!"
            exit 1
          fi

          echo "Все файлы сайта:"
          find . \( -name "*.html" -o -name "*.css" -o -name "*.js" -o -name "*.png" -o -name "*.jpg" \) | head -15

      - name: Deploy to server (systemd myapp)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROXY_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "=== Deploy via systemd myapp ==="

            cd /home/vboxuser/myapp

            echo "Fetching new code..."
            git fetch origin
            git reset --hard origin/github-actions

            echo "Restarting systemd service myapp..."
            sudo -n systemctl restart myapp || true

            echo "Checking myapp status..."
            sleep 2
            sudo -n systemctl status myapp || echo "WARNING: unable to get myapp status"

            echo "Checking port 8181..."
            curl -f http://localhost:8181 || echo "systemd site unreachable on 8181"

            echo "Checking domain..."
            curl -f http://app.artanov.course.prafdin.ru || echo "site not reachable by domain"

            echo "===deploy DONE ==="
