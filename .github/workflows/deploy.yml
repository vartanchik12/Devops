name: Deploy static site and Docker container

on:
  push:
    branches: [ github-actions ]

permissions:
  contents: read
  packages: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROXY_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "=====  деплой статического сайта через systemd ====="

            cd /home/***/myapp

            echo "Загружаем обновления..."
            git fetch origin
            git reset --hard origin/github-actions

            echo "Перезапускаем веб-сервер (systemd myapp)..."
            sudo -n systemctl restart myapp

            echo "Проверяем статус сервиса myapp:"
            sleep 2
            sudo -n systemctl status myapp  echo "WARNING: статус сервиса вернуть не удалось"

            echo "Деплой  завершен!"
            echo "Развернутые файлы :"
            ls -la

            echo "Проверка доступности сервиса на порту 8181:"
            curl -f http://localhost:8181  echo "Сервис на 8181 не отвечает"

            echo "Проверка доступности по домену :"
            curl -f http://app.artanov.course.prafdin.ru  echo "Сайт по домену не отвечает"
            echo "Сайт доступен по: http://app.artanov.course.prafdin.ru"

            echo "-----"
            echo "=====  деплой Docker-контейнера ====="

            IMAGE="ghcr.io/vartanchik12/devops/mysite:lab3"
            CONTAINER_NAME="mysite-lab3"
            HOST_PORT=8282

            echo "Логинимся в GitHub Container Registry..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.repository_owner }}" --password-stdin

            echo "Тянем свежий образ: $IMAGE"
            docker pull "$IMAGE"

            echo "Останавливаем старый контейнер (если есть)..."
            docker stop "$CONTAINER_NAME"  echo "Контейнер $CONTAINER_NAME не был запущен"

            echo "Удаляем старый контейнер (если есть)..."
            docker rm "$CONTAINER_NAME"  echo "Контейнер $CONTAINER_NAME не найден"

            echo "Запускаем новый контейнер..."
            docker run -d \
              --name "$CONTAINER_NAME" \
              -p ${HOST_PORT}:80 \
              --restart=always \
              "$IMAGE"

            echo "Проверяем доступность Docker-контейнера на http://localhost:${HOST_PORT}"
            sleep 2
            curl -f "http://localhost:${HOST_PORT}"  echo "Docker-контейнер на порту ${HOST_PORT} не отвечает"

            echo "Деплой завершен. Контейнер слушает порт ${HOST_PORT}."
            echo "Проверь по адресу: http://app.artanov.course.prafdin.ru (Лаба 2) и http://app.artanov.course.prafdin.ru:8282 (Лаба 3 через frp, если настроен)."
